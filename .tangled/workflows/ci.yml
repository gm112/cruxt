when:
  - event: ["pull_request"]
    branch: ["main"]

engine: "nixery"

dependencies:
  nixpkgs:
    - nodejs
    - busybox

steps:
  - name: Install dependencies
    command: |
        corepack enable
        pnpm install --frozen-lockfile

  - name: Build & Run tests
    command: |
        echo "Building Projects"
        pnpm run build:all & build_pid=$!

        echo "Validating Code Formatting"
        pnpm run lint:all & lint_pid=$!

        echo "Testing Projects"
        pnpm run test:all & test_pid=$!

        wait $build_pid; build_exit_code=$?
        wait $lint_pid; lint_exit_code=$?
        wait $test_pid; test_exit_code=$?

        if [ $build_exit_code -ne 0 ] || [ $lint_exit_code -ne 0 ] || [ $test_exit_code -ne 0 ]; then
          echo "Build, lint, or test failed. Exiting." >&2
          exit 1
        fi
